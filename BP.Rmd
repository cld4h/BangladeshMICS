---
title: Bayesian Poisson Model
---

# Load the data

```{r}
library("haven")
library("dplyr")
wm <- read_sav("wm.sav")
wm <- wm %>% arrange(HH1, HH2, WM3)
hh <- read_sav("hh.sav")
df_hh <- hh %>% select(HH1, HH2, HHSEX, HHAGE)
wm <- merge(x=wm, y=df_hh, by = c("HH1", "HH2"))
```


# Clean the data

(one line of code)
```{r}
wm <- wm %>% filter(MA1 == 1 & MT1!=9 & MT2!=9 & MT3!=9 & MA2!=98 & MA2!=99 & MA3!=9)
```

68709 women before cleaning the data

MA1: "Currently married"

```{r}
table(wm$MA1,useNA="ifany")
wm <- wm %>% filter(MA1==1)
```
    1     3  <NA>
51426 12951  4332

We exclude 12951 women who have never married and 4332 women with unknown status.
In total, 17283 samples were excluded.


Technology usage (22):
Missing data: media_newspaper (5), media_radio (3), media_tv(14)
```{r}
table(wm$MT1,useNA="ifany")
table(wm$MT2,useNA="ifany")
table(wm$MT3,useNA="ifany")
attr(wm$MT1, "labels")
wm <- wm %>% filter(MT1!=9 & MT2!=9 & MT3!=9)
```

other wives: (30)
```{r}
table(wm$MA3,useNA="ifany")
wm <- wm %>% filter(MA3!=9)
```

Age of husband (44)
(98 for "DK"; 99 for "NO RESPONSE")
```{r}
table(wm$MA2,useNA="ifany")
wm <- wm %>% filter(MA2!=98 & MA2!=99)
```

HHAGE
```{r}
table(wm$HHAGE,useNA="ifany")
```

No missing values for the following predictors:
```{r}
table(wm$HH6,useNA="ifany")
table(wm$HH7,useNA="ifany")
table(wm$HH7A,useNA="ifany")
#table(wm$wmweight,useNA="ifany")
table(wm$WAGEM,useNA="ifany")
table(wm$WB4,useNA="ifany")
table(wm$windex5,useNA="ifany")
table(wm$welevel,useNA="ifany")
table(wm$ethnicity,useNA="ifany")
table(wm$CM11,useNA="ifany")
```

# Summary

```{r}
women_age <- wm$WB4
women_age2 <- women_age^2
husband_age <- wm$MA2
husband_age2 <- husband_age^2
HH_age <- wm$HHAGE
HH_age2 <- wm$HHAGE^2
women_agem <- wm$WAGEM
division <- wm$HH7
ethnicity <- wm$ethnicity # Fixed
area <- wm$HH6 # Fixed
women_edu <- wm$welevel
HH_sex <- wm$HHSEX
other_wives <- wm$MA3
windex <- wm$windex5
media_newspaper <- ifelse(wm$MT1>0, 1, 0)
media_radio <- ifelse(wm$MT2>0, 1, 0)
media_tv <- ifelse(wm$MT3>0, 1, 0)
media <- media_newspaper|media_radio|media_tv
media <- ifelse(media,1,0)
# Response variable
CEB <- wm$CM11
# District
district <- wm$HH7A
# Sampling weight
wgt <- wm$wmweight

mean(women_age)
sd(women_age)
mean(husband_age)
sd(husband_age)
mean(HH_age)
sd(HH_age)
mean(women_agem)
sd(women_agem)

total <- dim(wm)[1]
table(division)
round(table(division)/total,4)
table(area)
round(table(area)/total,4)

attr(wm$welevel, "labels")
table(women_edu)
round(table(women_edu)/total,4)

attr(wm$welevel, "labels")
table(women_edu)
round(table(women_edu)/total,4)

attr(wm$HHSEX, "labels")
table(wm$HHSEX)
round(table(wm$HHSEX)/total,4)

attr(other_wives, "labels")
table(other_wives)
round(table(other_wives)/total,4)

attr(windex, "labels")
table(windex)
round(table(windex)/total,4)

table(media)
round(table(media)/total,4)

attr(wm$ethnicity, "labels")
table(ethnicity)
round(table(ethnicity)/total,4)
```


```{r}
IMAGEOUT <- "./pics/BP/"
par(mar=c(4,4.5,1,1),mgp=c(1.88,0.50,0))
barplot(table(CEB), ylab="Frequency",
        xlab="Number of children ever born", cex.lab = 2, names.arg=c(0:12), font.axis = 2.5)
dev.print(pdf,
	paste(IMAGEOUT,"CEB_histo.pdf",sep=""),
	width=16,height=12)
```


```{r}
y <- CEB
division <- factor(division, levels = c(10,20,30,40,45,50,55,60), labels = c("Barishal", "Chattogram", "Dhaka", "Khulna", "Mymenshing", "Rajshahi", "Rangpur", "Sylhet"))
division <- relevel(division, ref=3)

division <- model.matrix(~division, data = division)
colnames(division) <- c(
  "Dhaka.ref",
  "Barishal",
  "Chattogram",
  "Khulna",
  "Mymenshing",
  "Rajshahi",
  "Rangpur",
  "Sylhet"
)

district_names <- c("Bagerhat", "Bandarban", "Barguna", "Barishal", "Bhola", "Bogura", "Brahmanbaria", "Chandpur", "Chapai Nawabganj", "Chattogram", "Chuadanga", "Cox's Bazar", "Cumilla", "Dhaka", "Dinajpur", "Faridpur", "Feni", "Gaibandha", "Gazipur", "Gopalganj", "Habiganj", "Jamalpur", "Jashore", "Jhalokati", "Jhenaidah", "Joypurhat", "Khagrachhari", "Khulna", "Kishoregonj", "Kurigram", "Kushtia", "Lakshmipur", "Lalmonirhat", "Madaripur", "Magura", "Manikganj", "Maulvibazar", "Meherpur", "Munshiganj", "Mymensingh", "Naogaon", "Narail", "Narayangonj", "Narsingdi", "Natore", "Netrokona", "Nilphamari", "Noakhali", "Pabna", "Panchagarh", "Patuakhali", "Pirojpur", "Rajbari", "Rajshahi", "Rangamati", "Rangpur", "Satkhira", "Shariatpur", "Sherpur", "Sirajganj", "Sunamganj", "Sylhet", "Tangail", "Thakurgaon")
district_codes <- c(1, 3, 4, 6, 9, 10, 12, 13, 15, 18, 19, 22, 26, 27, 29, 30, 32, 33, 35, 36, 38, 39, 41, 42, 44, 46, 47, 48, 49, 50, 51, 52, 54, 55, 56, 57, 58, 59, 61, 64, 65, 67, 68, 69, 70, 72, 73, 75, 76, 77, 78, 79, 81, 82, 84, 85, 86, 87, 88, 89, 90, 91, 93, 94)

district <- factor(district, levels = district_codes, labels = district_names)

women_edu <- factor(women_edu)
women_edu <- model.matrix(~women_edu, data = women_edu)

windex <- factor(windex)
windex <- relevel(windex, ref=3)
windex <- model.matrix(~windex, data = windex)
colnames(windex) <- c(
  "windex.Middle.ref",
  "windex.Poorest",
  "windex.Poor",
  "windex.Rich",
  "windex.Richest"
)

area <- ifelse(area==2, 0, 1)
area <- factor(area)
area <- relevel(area, ref = 1)

other_wives <- ifelse(other_wives==2, 0, 1)
other_wives <- factor(other_wives)

media <- factor(media)
media <- relevel(media, ref = 1)
```


## Utility functions and data
```{r}
#######################utility functions######################
## mvnormal simulation
rmvnorm<-function(n,mu,Sigma)
{
  E<-matrix(rnorm(n*length(mu)),n,length(mu))
  t(  t(E%*%chol(Sigma)) +c(mu))
}

## Wishart simulation
rwish<-function(n,nu0,S0)
{
  sS0 <- chol(S0)
  S<-array( dim=c( dim(S0),n ) )
  for(i in 1:n)
  {
     Z <- matrix(rnorm(nu0 * dim(S0)[1]), nu0, dim(S0)[1]) %*% sS0
     S[,,i]<- t(Z)%*%Z
  }
  S[,,1:n]
}
## mvnorm log density
ldmvnorm<-function(X,mu,Sigma,iSigma=solve(Sigma),dSigma=det(Sigma))
{
  Y<-t( t(X)-mu)
  sum(diag(-.5*t(Y)%*%Y%*%iSigma))  -
  .5*(  prod(dim(X))*log(2*pi) +     dim(X)[1]*log(dSigma) )
}
## Calculate matrix multiplication: (1,Z) %*% Beta
matmul <- function(Z, Beta){
nZ <- nrow(Z)
as.matrix(cbind(rep(1,nZ),Z))%*%as.matrix(Beta)
}
#######################utility functions######################

#######################design matrix##########################
# Design matrix for all varables (random x14 | fixed x21)
X <- as.matrix(cbind(
	### random predictors
  women_age,
  women_age2,
  husband_age,
  #husband_age2,
  HH_age,
  #HH_age2,
  women_agem,
  women_edu[,-1],
  windex[,-1],
  media,
  other_wives,
  area,
  HH_sex,
	### fixed predictor
  division[,-1],# 7
  ethnicity
))

# Concat response variable y with design matrix of X
yX <- cbind(y,X)
#######################design matrix##########################
```


## Init

```{r}
#######################initial values#########################
p<-dim(X)[2] + 1# number of columns in X (20) + 1 (intercept)

# The initial mean of the MVN prior of theta
model <- glm(y~., data = data.frame(yX), family=poisson)
THETA <- mu0 <- model$coefficients

# The initial variance of the MVN prior for the variance of theta
# LAMBDA is the inverse of Fisher information matrix
LAMBDA <- vcov(model)

# The accepted count of proposed theta
ACCEPT.Theta.count <- 0
SIGMA.post<-NULL
THETA.post <- list()
S=220000
B=20000
thin=50
#######################initial values#########################
```

```{r eval=FALSE}
#######################simulation#############################
set.seed(123)
start.time <- Sys.time()
for(s in 1:S)
{
	##update theta
	# theta proposed
	K_theta <- 0.05
	theta.p<-t(rmvnorm(1,THETA,K_theta*LAMBDA))
	lr<-0
	lr <- lr+sum(
		wgt * dpois(y,
			lambda=exp(matmul(X,theta.p)),log=TRUE),
		-wgt * dpois(y,
			lambda=exp(matmul(X,THETA)),log=TRUE),
	  ldmvnorm(t(theta.p),mu0,LAMBDA),
    -ldmvnorm(t(THETA),mu0,LAMBDA)
  )
	#print("lr is")
	#print(lr)
	if( log(runif(1))<lr ) {
		ACCEPT.Theta.count<- ACCEPT.Theta.count+1
		THETA<-theta.p
	}

	##store some output
	if((s %% thin == 0) & (s > B)) # saving every 10th value
	{
		cat("Current iteration index = ", s, "\n")
		# Print current acceptance rate
		cat("Current acceptance rate of Theta = ", round((ACCEPT.Theta.count/s)*100, digits = 2),"\n")
		# save thinned coefficients
		THETA.post<-rbind(THETA.post,t(THETA))
	}
}
end.time <- Sys.time()
#######################simulation#############################
```

## Save and load results

```{r eval=FALSE}
RESULTPATH = "./data_output/BP/"
save(THETA.post, file=paste(RESULTPATH,"THETA.post.S=",S,".RData",sep=""))
save(ACCEPT.Theta.count, file=paste(RESULTPATH,"ACCEPT.Theta.count.S=",S,".RData",sep=""))
```

```{r eval=TRUE}
RESULTPATH = "./data_output/BP/"
load(paste(RESULTPATH,"THETA.post.S=",S,".RData",sep=""))
load(paste(RESULTPATH,"ACCEPT.Theta.count.S=",S,".RData",sep=""))
```

# Plot results

## Assess the convergence of the Markov chain

```{r}
## stationarity plot - boxplot
stationarity.plot<-function(x,...){
S<-length(x)
scan<-1:S
ng<-min( round(S/100),10)
group<-S*ceiling( ng*scan/S) /ng
boxplot(x~group,...)
}
```

```{r}
# convert the result into a 26x(S-B) matrix
THETA.post.mat <- NULL
for (i in c(1:dim(THETA.post)[1])){
THETA.post.mat <- cbind(THETA.post.mat, as.matrix(unlist(t(THETA.post)[,i])) )
}

#stationarity.plot(THETA.post[, 1],xlab="iteration",ylab=expression(theta[11]))
par(mfrow = c(5, 6), mar=c(3,2,1,1),mgp=c(2,1,0))
for (i in 1:p) {
plot(seq(1,(S-B)/thin,by=1), THETA.post[,i], type = "l", xlab = "Iterations", ylab = expression(theta), main=i)
}
dev.print(pdf,
	paste(IMAGEOUT,"THETA.post.pdf",sep=""),
	width=16,height=12)

library(coda)
par(mfrow = c(5, 6), mar=c(3,2,1,1),mgp=c(2,1,0))
for (i in 1:p){
esize <- effectiveSize(unlist(THETA.post[,i]))
acf_plot <- acf(unlist(THETA.post[,i]), plot = FALSE)
t <- paste(i,",Effective Size: ", esize, sep="")
plot(acf_plot, xlab=t, ylab="", main=t)
}
dev.print(pdf,
	paste(IMAGEOUT,"ACF.THETA.post.pdf",sep=""),
	width=16,height=12)
```

## Dispersion Test

```{r}
fit.mle <- glm(y~., data = data.frame(yX), family=poisson)
library(AER)
sink(paste(IMAGEOUT,"dispersion.txt",sep=""))
dispersiontest(fit.mle, alternative = "less")
sink()
```


### Posterior estimates with 95% credible intervals (CI) of the incidence rate ratio (IRR) for the explanatory variables

```{r}
library(xtable)
CI_THETA <- round(t(apply(exp(THETA.post.mat), 1, quantile ,probs=c(0.50, 0.025, 0.975))), digits = 5)
CI_THETA
sink(paste(IMAGEOUT,"CI_THETA.tex",sep=""))
xtable(CI_THETA, digits = 3)
sink()
```

```{r}
# Calculation of BIC (Weighted)
n<-length(y)
BIC_W <- p * log(n) - 2 * sum(wgt*dpois(y,exp(matmul(X,as.matrix(apply(THETA.post.mat, 1, mean)))),log=T))
print(BIC_W)
```

## Calculate the expected number of CEB

### Expected Children Ever Born - Woman's age

```{r}
Xs <- apply(X, 2, mean)
Xs <- matrix(rep(Xs, 35), nrow = 35, byrow = T)
Xs[,1] <- seq(15, 49, by = 1)
Xs[,2] <- (seq(15, 49, by = 1)^2)
colnames(Xs) <- colnames(X)
Xs = cbind(rep(1,35),Xs) # insert the first column of 1 for intercept
eXB.post <- exp(Xs%*%THETA.post.mat)
qE<-apply(t(eXB.post),2,quantile,probs=c(.025,.5,.975))

sample_size <- NULL
for (v in 15:49){
	sample_size <- c(sample_size, sum(X[,1]==v))
}
qE <- rbind(qE,sample_size)

colnames(qE)<-as.character(15:49)
write.csv(t(qE), paste(IMAGEOUT,"qE.women_age.csv",sep=""))

par(mar=c(4,4.5,1,1),mgp=c(1.88,0.50,0))
plot( c(15, 49),range(c(0,qE)),type="n",xlab="Woman's age",ylim=c(0,4),
      ylab="Expected number of children ever born", cex.lab = 2.5, cex.axis = 1.5)
lines(seq(15, 49, by = 1), qE[1,],col="black",lwd=0.5)
lines(seq(15, 49, by = 1), qE[2,],col="black",lwd=1.0)
lines(seq(15, 49, by = 1), qE[3,],col="black",lwd=0.5)
dev.print(pdf,
	paste(IMAGEOUT,"E_women_age.pdf",sep=""),
	width=16,height=16)
```

### Expected Children Ever Born - Husband's age

```{r}
Xs <- apply(X, 2, mean)
Xs[2] <- Xs[1]^2
Xs <- matrix(rep(Xs, 76), nrow = 76, byrow = T)
Xs[,3] <- seq(15, 90, by = 1)
colnames(Xs) <- colnames(X)
Xs = cbind(rep(1,76),Xs) # insert the first column of 1 for intercept
eXB.post <- exp(Xs%*%THETA.post.mat)
qE<-apply(t(eXB.post),2,quantile,probs=c(.025,.5,.975))

sample_size <- NULL
for (v in 15:90){
	sample_size <- c(sample_size, sum(X[,3]==v))
}
qE <- rbind(qE,sample_size)

colnames(qE)<-as.character(15:90)
write.csv(t(qE), paste(IMAGEOUT,"qE.husband_age.csv",sep=""))

par(mar=c(4,4.5,1,1),mgp=c(1.88,0.50,0))
plot( c(15, 90),range(c(0,qE)),type="n",xlab="Husband's age",ylim=c(1.5,3),
      ylab="Expected number of children ever born", cex.lab = 2.5, cex.axis = 1.5)
lines(seq(15, 90, by = 1), qE[1,],col="black",lwd=0.5)
lines(seq(15, 90, by = 1), qE[2,],col="black",lwd=1.0)
lines(seq(15, 90, by = 1), qE[3,],col="black",lwd=0.5)
dev.print(pdf,
	paste(IMAGEOUT,"E_husband_age.pdf",sep=""),
	width=16,height=16)
```

### Expected Children Ever Born - Household head's age

```{r}
Xs <- apply(X, 2, mean)
Xs[2] <- Xs[1]^2
Xs <- matrix(rep(Xs, 80), nrow = 80, byrow = T)
Xs[,4] <- seq(16, 95, by = 1)
colnames(Xs) <- colnames(X)
Xs = cbind(rep(1,80),Xs) # insert the first column of 1 for intercept
eXB.post <- exp(Xs%*%THETA.post.mat)
qE<-apply(t(eXB.post),2,quantile,probs=c(.025,.5,.975))

sample_size <- NULL
for (v in 16:95){
	sample_size <- c(sample_size, sum(X[,4]==v))
}
qE <- rbind(qE,sample_size)

colnames(qE)<-as.character(16:95)
write.csv(t(qE), paste(IMAGEOUT,"qE.HH_age.csv",sep=""))

par(mar=c(4,4.5,1,1),mgp=c(1.88,0.50,0))
plot( c(16, 95),range(c(0,qE)),type="n",xlab="Household head's age",ylim=c(1.5,3),
      ylab="Expected number of children ever born", cex.lab = 2.5, cex.axis = 1.5)
lines(seq(16, 95, by = 1), qE[1,],col="black",lwd=0.5)
lines(seq(16, 95, by = 1), qE[2,],col="black",lwd=1.0)
lines(seq(16, 95, by = 1), qE[3,],col="black",lwd=0.5)
dev.print(pdf,
	paste(IMAGEOUT,"E_HH_age.pdf",sep=""),
	width=16,height=16)
```

### Expected Children Ever Born - Woman's age at marriage

```{r}
Xs <- apply(X, 2, mean)
Xs[2] <- Xs[1]^2
Xs <- matrix(rep(Xs, 44), nrow = 44, byrow = T)
Xs[,5] <- seq(5, 48, by = 1)
colnames(Xs) <- colnames(X)
Xs = cbind(rep(1,44),Xs)
eXB.post <- exp(Xs%*%THETA.post.mat)
qE<-apply(t(eXB.post),2,quantile,probs=c(.025,.5,.975))

sample_size <- NULL
for (v in 5:48){
	sample_size <- c(sample_size, sum(X[,5]==v))
}
qE <- rbind(qE,sample_size)

colnames(qE)<-as.character(5:48)
write.csv(t(qE), paste(IMAGEOUT,"qE.women_agem.csv",sep=""))

par(mar=c(4,4.5,1,1),mgp=c(1.88,0.50,0))
plot( c(5, 48),range(c(0,qE)),type="n",xlab="Woman's age at marriage",ylim=c(0,4),
      ylab="Expected number of children ever born", cex.lab = 2.5, cex.axis = 1.5)
lines(seq(5, 48, by = 1), qE[1,],col="black",lwd=0.5)
lines(seq(5, 48, by = 1), qE[2,],col="black",lwd=1.0)
lines(seq(5, 48, by = 1), qE[3,],col="black",lwd=0.5)
dev.print(pdf,
	paste(IMAGEOUT,"E_women_agem.pdf",sep=""),
	width=16,height=16)
```

### Expected Children Ever Born - Division

```{r}
# Expected Number of Children Ever Born in Bangladesh
Xs <- apply(X, 2, mean)
Xs[2] <- Xs[1]^2
Xs <- as.matrix(c(1, Xs))
eXB.post<- exp(t(t(Xs)%*%THETA.post.mat) )
qEA<-apply( eXB.post,2,quantile,probs=c(.025,.5,.975))
round(qEA, digits = 3)
qEA <- rbind(qEA,dim(X)[1])
# Division

dnames <- c(
  "Bangladesh",
  "Dhaka",
  "Barishal",
  "Chattogram",
  "Khulna",
  "Mymenshing",
  "Rajshahi",
  "Rangpur",
  "Sylhet"
)

Xs <- apply(X, 2, mean)
Xs[2] <- Xs[1]^2
Xs <- matrix(rep(Xs, 8), nrow = 8, byrow = T)
for (div_index in c(2:8)){
	x <- rep(0,8)
	x[div_index] <- 1
	Xs[,(15+div_index)] <- x
}
colnames(Xs) <- colnames(X)
Xs = cbind(rep(1,8),Xs)

eXB.post<- exp(t(Xs%*%THETA.post.mat) )
qE<-apply( eXB.post,2,quantile,probs=c(.025,.5,.975))

sample_size <- sum(wm$HH7==30) # count number of women in Herat(reference levels)
for (HH7 in c(10,20,40,45,50,55,60)){
	sample_size <- c(sample_size, sum(wm$HH7==HH7))
}
qE <- rbind(qE,sample_size)

qE.out <- cbind(qEA,qE)
colnames(qE.out)<-dnames
write.csv(t(qE.out), paste(IMAGEOUT,"qE.province.csv",sep=""))

index <- order(qE[2,])
index <- c(1, index + 1)

library(ggplot2)
BP.df_division <- data.frame(x =1:9,
                 F = qE.out[2,][index],
                 L = qE.out[1,][index],
                 U = qE.out[3,][index],
              name = dnames[index])
abc <- ggplot(BP.df_division, aes(x = x, y = F)) +
  labs(y = "Expected number of children ever born", x = "Divisions") +
  ylim(1.9,3.0) +
  geom_point(size = 2) +
  geom_errorbar(aes(ymax = U, ymin = L)) +
  scale_x_continuous(breaks = c(1:9), labels = dnames[index]) +
  theme(axis.title=element_text(size=18), axis.text.x = element_text(size = 12, color = "black", angle = 45, vjust = 1, hjust = 1),
        axis.ticks.x = element_line(color = "black", linewidth = 1),
        axis.text.y = element_text(size = 18, color = "black"),
        axis.ticks.y = element_line(color = "black", linewidth = 1))
print(abc)
save(BP.df_division, file=paste(IMAGEOUT,"BP.df_division.RData",sep=""))
#dev.print(device = postscript, paste(IMAGEOUT, "E_province.eps",sep=""),width=8,height=8, horizontal = FALSE)
dev.print(pdf, paste(IMAGEOUT, "E_division.pdf",sep=""),width=8,height=8)
```

### Expected Children Ever Born - Ethnicity

```{r}
anames<- c("Bengali", "Other")
index <- c(1, 2)
anames[index]

Xs <- apply(X, 2, mean)
Xs[2] <- Xs[1]^2
Xs <- as.matrix(c(1, Xs))
Xs <- matrix(rep(Xs, 2), nrow = 2, byrow = T)
Xs[,25] <- c(1, 2) # 2 for Other, 1 for Bengali

eXB.post<- exp(t(Xs%*%THETA.post.mat) )
qE<-apply( eXB.post,2,quantile,probs=c(.025,.5,.975))

sample_size <- c(sum(X[,23]==1), sum(X[,23]==2)) # Bengali , Other
qE <- rbind(qE,sample_size)

colnames(qE)<-anames
write.csv(t(qE), paste(IMAGEOUT,"qE.ethnicity.csv",sep=""))

BP.df_ethnicity <- data.frame(x =1:2,
                 F = c(qE[2,])[index],
                 L = c(qE[1,])[index],
                 U = c(qE[3,])[index])
abc <- ggplot(BP.df_ethnicity, aes(x = x, y = F)) +
  labs(y = "Expected number of children ever born", x = "Ethnicity") +
  geom_point(size = 2) +
  ylim(1.8,2.4) +
  geom_errorbar(aes(ymax = U, ymin = L)) +
  scale_x_continuous(breaks = c(1:2), labels = anames[index]) +
  theme(axis.title=element_text(size=18), axis.text.x = element_text(size = 18, color = "black", angle = 45, vjust = 1, hjust = 1),
        axis.ticks.x = element_line(color = "black", linewidth = 1),
        axis.text.y = element_text(size = 18, color = "black"),
        axis.ticks.y = element_line(color = "black", linewidth = 1))
print(abc)

save(BP.df_ethnicity, file=paste(IMAGEOUT,"BP.df_ethnicity.RData",sep=""))
dev.print(pdf, paste(IMAGEOUT, "E_ethnicity.pdf",sep=""),width=8,height=8)
(qE[2,][1] - qE[2,][2])/qE[2,][2]
```

### Expected Children Ever Born - Area

```{r}
anames<- c("Rural", "Urban")
index <- c(1, 2)
anames[index]

Xs <- apply(X, 2, mean)
Xs[2] <- Xs[1]^2
Xs <- as.matrix(c(1, Xs))
Xs <- matrix(rep(Xs, 2), nrow = 2, byrow = T)
Xs[,16] <- c(1, 2) # 2 for Urban, 1 for Rural

eXB.post<- exp(t(Xs%*%THETA.post.mat) )
qE<-apply( eXB.post,2,quantile,probs=c(.025,.5,.975))

sample_size <- c(sum(X[,15]==1), sum(X[,15]==2)) # Rural, Urban
qE <- rbind(qE,sample_size)

colnames(qE)<-anames
write.csv(t(qE), paste(IMAGEOUT,"qE.area.csv",sep=""))

BP.df_area <- data.frame(x =1:2,
                 F = c(qE[2,])[index],
                 L = c(qE[1,])[index],
                 U = c(qE[3,])[index])
abc <- ggplot(BP.df_area, aes(x = x, y = F)) +
  labs(y = "Expected number of children ever born", x = "Area of residence") +
  geom_point(size = 2) +
  ylim(2.2,2.4) +
  geom_errorbar(aes(ymax = U, ymin = L)) +
  scale_x_continuous(breaks = c(1:2), labels = anames[index]) +
  theme(axis.title=element_text(size=18), axis.text.x = element_text(size = 18, color = "black", angle = 45, vjust = 1, hjust = 1),
        axis.ticks.x = element_line(color = "black", linewidth = 1),
        axis.text.y = element_text(size = 18, color = "black"),
        axis.ticks.y = element_line(color = "black", linewidth = 1))
print(abc)

save(BP.df_area, file=paste(IMAGEOUT,"BP.df_area.RData",sep=""))
dev.print(pdf, paste(IMAGEOUT, "E_area.pdf",sep=""),width=8,height=8)
(qE[2,][1] - qE[2,][2])/qE[2,][2]
```

### Expected Children Ever Born - Women's education

```{r}
winames <- c("Pre-primary or none", "Primary", "Secondary", "Higher secondary+")
index <- c(1, 2, 3, 4)
winames[index]

Xs <- apply(X, 2, mean)
Xs[2] <- Xs[1]^2
Xs <- as.matrix(c(1, Xs))
Xs <- matrix(rep(Xs, 4), nrow = 4, byrow = T)
Xs[,7] <- c(0, 1, 0, 0)
Xs[,8] <- c(0, 0, 1, 0)
Xs[,9] <- c(0, 0, 0, 1)

eXB.post<- exp(t(Xs%*%THETA.post.mat) )
qE<-apply( eXB.post,2,quantile,probs=c(.025,.5,.975))

sample_size <- NULL
for (edu in 0:3){
	sample_size <- c(sample_size, sum(wm$welevel==edu))
}
qE <- rbind(qE,sample_size)

colnames(qE)<-winames
write.csv(t(qE), paste(IMAGEOUT,"qE.women_edu.csv",sep=""))

BP.df_women_edu <- data.frame(x =1:4,
                 F = c(qE[2,])[index],
                 L = c(qE[1,])[index],
                 U = c(qE[3,])[index])
abc <- ggplot(BP.df_women_edu, aes(x = x, y = F)) +
  labs(y = "Expected number of children ever born", x = "Women's education", cex.lab = 2.5, cex.axis = 1.5) +
  geom_point(size = 2) +
  ylim(1.9,2.6) +
  geom_errorbar(aes(ymax = U, ymin = L)) +
  scale_x_continuous(breaks = c(1:4), labels = winames[index]) +
  theme(axis.title=element_text(size=18), axis.text.x = element_text(size = 18, color = "black", angle = 45, vjust = 1, hjust = 1),
        axis.ticks.x = element_line(color = "black", linewidth = 1),
        axis.text.y = element_text(size = 18, color = "black"),
        axis.ticks.y = element_line(color = "black", linewidth = 1))
print(abc)
save(BP.df_women_edu, file=paste(IMAGEOUT,"BP.df_women_edu.RData",sep=""))

dev.print(pdf, paste(IMAGEOUT, "E_women_edu.pdf",sep=""),width=8,height=8)
```

### Expected Children Ever Born - Wealth Index

```{r}
winames <- c("Middle", "Poorest", "Poor", "Rich", "Richest")
index <- c(2, 3, 1, 4, 5)
winames[index]

Xs <- apply(X, 2, mean)
Xs[2] <- Xs[1]^2
Xs <- as.matrix(c(1, Xs))
Xs <- matrix(rep(Xs, 5), nrow = 5, byrow = T)
Xs[,10] <- c(0, 1, 0, 0, 0)
Xs[,11] <- c(0, 0, 1, 0, 0)
Xs[,12] <- c(0, 0, 0, 1, 0)
Xs[,13] <- c(0, 0, 0, 0, 1)

eXB.post<- exp(t(Xs%*%THETA.post.mat) )
qE<-apply( eXB.post,2,quantile,probs=c(.025,.5,.975))

sample_size <- sum(wm$windex5==3)
for (wealth in c(1,2,4,5)){
	sample_size <- c(sample_size, sum(wm$windex5==wealth))
}
qE <- rbind(qE,sample_size)

colnames(qE)<-winames
write.csv(t(qE), paste(IMAGEOUT,"qE.windex.csv",sep=""))

BP.df_windex5 <- data.frame(x =1:5,
                 F = c(qE[2,])[index],
                 L = c(qE[1,])[index],
                 U = c(qE[3,])[index])
abc <- ggplot(BP.df_windex5, aes(x = x, y = F)) +
  labs(y = "Expected number of children ever born", x = "Wealth index", cex.lab = 2.5, cex.axis = 1.5) +
  geom_point(size = 2) +
  ylim(2,2.6) +
  geom_errorbar(aes(ymax = U, ymin = L)) +
  scale_x_continuous(breaks = c(1:5), labels = winames[index]) +
  theme(axis.title=element_text(size=18), axis.text.x = element_text(size = 18, color = "black", angle = 45, vjust = 1, hjust = 1),
        axis.ticks.x = element_line(color = "black", linewidth = 1),
        axis.text.y = element_text(size = 18, color = "black"),
        axis.ticks.y = element_line(color = "black", linewidth = 1))
print(abc)

save(BP.df_windex5, file=paste(IMAGEOUT,"BP.df_windex5.RData",sep=""))
dev.print(pdf, paste(IMAGEOUT, "E_windex5.pdf",sep=""),width=8,height=8)
```

### Expected Children Ever Born - other wives

```{r}
anames<- c("No", "Yes")
index <- c(1, 2)
anames[index]

Xs <- apply(X, 2, mean)
Xs[2] <- Xs[1]^2
Xs <- as.matrix(c(1, Xs))
Xs <- matrix(rep(Xs, 2), nrow = 2, byrow = T)
Xs[,15] <- c(1, 2) # 2 for Yes, 1 for No

eXB.post<- exp(t(Xs%*%THETA.post.mat) )
qE<-apply( eXB.post,2,quantile,probs=c(.025,.5,.975))

sample_size <- c(sum(X[,14]==1), sum(X[,14]==2)) # No, Yes
qE <- rbind(qE,sample_size)

colnames(qE)<-anames
write.csv(t(qE), paste(IMAGEOUT,"qE.other_wives.csv",sep=""))

BP.df_other_wives <- data.frame(x =1:2,
                 F = c(qE[2,])[index],
                 L = c(qE[1,])[index],
                 U = c(qE[3,])[index])
abc <- ggplot(BP.df_other_wives, aes(x = x, y = F)) +
  labs(y = "Expected number of children ever born", x = "Having other wives") +
  geom_point(size = 2) +
  ylim(1.9,2.4) +
  geom_errorbar(aes(ymax = U, ymin = L)) +
  scale_x_continuous(breaks = c(1:2), labels = anames[index]) +
  theme(axis.title=element_text(size=18), axis.text.x = element_text(size = 18, color = "black", angle = 45, vjust = 1, hjust = 1),
        axis.ticks.x = element_line(color = "black", linewidth = 1),
        axis.text.y = element_text(size = 18, color = "black"),
        axis.ticks.y = element_line(color = "black", linewidth = 1))
print(abc)

save(BP.df_other_wives, file=paste(IMAGEOUT,"BP.df_other_wives.RData",sep=""))
dev.print(pdf, paste(IMAGEOUT, "E_other_wives.pdf",sep=""),width=8,height=8)
(qE[2,][1] - qE[2,][2])/qE[2,][2]
```

### Expected Children Ever Born - media

```{r}
anames<- c("No", "Yes")
index <- c(1, 2)
anames[index]

Xs <- apply(X, 2, mean)
Xs[2] <- Xs[1]^2
Xs <- as.matrix(c(1, Xs))
Xs <- matrix(rep(Xs, 2), nrow = 2, byrow = T)
Xs[,14] <- c(1, 2) # 2 for Yes, 1 for No

eXB.post<- exp(t(Xs%*%THETA.post.mat) )
qE<-apply( eXB.post,2,quantile,probs=c(.025,.5,.975))

sample_size <- c(sum(X[,13]==1), sum(X[,13]==2)) # No, Yes
qE <- rbind(qE,sample_size)

colnames(qE)<-anames
write.csv(t(qE), paste(IMAGEOUT,"qE.media.csv",sep=""))

BP.df_media <- data.frame(x =1:2,
                 F = c(qE[2,])[index],
                 L = c(qE[1,])[index],
                 U = c(qE[3,])[index])
abc <- ggplot(BP.df_media, aes(x = x, y = F)) +
  labs(y = "Expected number of children ever born", x = "Media access") +
  geom_point(size = 2) +
  ylim(2.2,2.45) +
  geom_errorbar(aes(ymax = U, ymin = L)) +
  scale_x_continuous(breaks = c(1:2), labels = anames[index]) +
  theme(axis.title=element_text(size=18), axis.text.x = element_text(size = 18, color = "black", angle = 45, vjust = 1, hjust = 1),
        axis.ticks.x = element_line(color = "black", linewidth = 1),
        axis.text.y = element_text(size = 18, color = "black"),
        axis.ticks.y = element_line(color = "black", linewidth = 1))
print(abc)

save(BP.df_media, file=paste(IMAGEOUT,"BP.df_media.RData",sep=""))
dev.print(pdf, paste(IMAGEOUT, "E_media.pdf",sep=""),width=8,height=8)
(qE[2,][1] - qE[2,][2])/qE[2,][2]
```

### Expected Children Ever Born - Household head's sex

```{r}
anames<- c("Male", "Female")
index <- c(1, 2)
anames[index]

Xs <- apply(X, 2, mean)
Xs[2] <- Xs[1]^2
Xs <- as.matrix(c(1, Xs))
Xs <- matrix(rep(Xs, 2), nrow = 2, byrow = T)
Xs[,17] <- c(1, 2) # 2 for Female, 1 for Male

eXB.post<- exp(t(Xs%*%THETA.post.mat) )
qE<-apply( eXB.post,2,quantile,probs=c(.025,.5,.975))

sample_size <- c(sum(X[,16]==1), sum(X[,16]==2)) # Male, Female
qE <- rbind(qE,sample_size)

colnames(qE)<-anames
write.csv(t(qE), paste(IMAGEOUT,"qE.HH_sex.csv",sep=""))

BP.df_HH_sex <- data.frame(x =1:2,
                 F = c(qE[2,])[index],
                 L = c(qE[1,])[index],
                 U = c(qE[3,])[index])
abc <- ggplot(BP.df_HH_sex, aes(x = x, y = F)) +
  labs(y = "Expected number of children ever born", x = "Household head's sex") +
  geom_point(size = 2) +
  ylim(2.0,2.4) +
  geom_errorbar(aes(ymax = U, ymin = L)) +
  scale_x_continuous(breaks = c(1:2), labels = anames[index]) +
  theme(axis.title=element_text(size=18), axis.text.x = element_text(size = 18, color = "black", angle = 45, vjust = 1, hjust = 1),
        axis.ticks.x = element_line(color = "black", linewidth = 1),
        axis.text.y = element_text(size = 18, color = "black"),
        axis.ticks.y = element_line(color = "black", linewidth = 1))
print(abc)

save(BP.df_HH_sex, file=paste(IMAGEOUT,"BP.df_HH_sex.RData",sep=""))
dev.print(pdf, paste(IMAGEOUT, "E_HH_sex.pdf",sep=""),width=8,height=8)
(qE[2,][1] - qE[2,][2])/qE[2,][2]
```
